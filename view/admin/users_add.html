<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>用户信息管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/lib/layui-v2.6.3/css/layui.css" media="all">
  <link rel="stylesheet" href="/css/public.css" media="all">
  <style>
    .avatar-uploader {
      margin-bottom: 15px;
      text-align: center;
    }
    .avatar-preview {
      position: relative;
      width: 120px;
      height: 120px;
      border: 1px dashed #d9d9d9;
      border-radius: 50%;
      overflow: hidden;
      margin: 10px auto;
      background-color: #f8f8f8;
    }
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .avatar-actions {
      margin-top: 10px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .layui-form-item .layui-form-label {
      width: 100px;
    }
    .layui-form-item .layui-input-block {
      margin-left: 130px;
    }
    .layui-form-item .layui-input-inline {
      width: 190px;
    }
    .form-container {
      padding: 20px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    /* 图片上传样式 */
    .multi-uploader {
      margin-top: 20px;
    }
    .upload-title {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }
    .images-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .image-item {
      position: relative;
      width: 100%;
      height: 120px;
      border: 1px dashed #d9d9d9;
      border-radius: 4px;
      overflow: hidden;
      background-color: #f8f8f8;
    }
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px;
      display: flex;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .image-item:hover .image-actions {
      opacity: 1;
    }
    .image-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      cursor: pointer;
    }
    .image-placeholder i {
      font-size: 30px;
      margin-bottom: 5px;
    }
    .image-count {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
    .upload-success {
      border-color: #5FB878;
    }
    .upload-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #f0f0f0;
    }
    .progress-bar {
      height: 100%;
      background: #5FB878;
      width: 0%;
      transition: width 0.3s;
    }
    .uploading .image-actions {
      display: none;
    }
    .single-image-mode .image-item:not(:first-child) {
      display: none;
    }
    /* 新增样式 */
    .upload-button-container {
      margin-bottom: 15px;
    }
    .image-item .layui-btn {
      padding: 0 8px;
      margin: 0 2px;
    }
    .image-item .layui-btn i {
      font-size: 14px;
    }
    .upload-trigger {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }
    .delete-btn {
      margin: 0 5px;
    }
  </style>
</head>

<body>
<div class="layuimini-container">
  <div class="layuimini-main form-container">

    <form class="layui-form" action="">

      <!-- 多图片上传区域 -->
      <div class="layui-form-item">
        <label class="layui-form-label">上传图片</label>
        <div class="layui-input-block">
          <div class="multi-uploader">
            <div class="upload-title">上传图片（最多9张）</div>
            
            <!-- 上传按钮区域 -->
            <div class="upload-button-container" id="upload-button-container">
              <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="upload-btn">
                  <i class="layui-icon">&#xe67c;</i>选择图片
                </button>
              </div>
            </div>
            
            <!-- 图片预览区域 -->
            <div class="images-container" id="images-grid">
              <!-- 初始占位符 -->
              <div class="image-item image-placeholder" id="upload-placeholder">
                <div class="upload-trigger">
                  <i class="layui-icon">&#xe681;</i>
                  <span>添加图片</span>
                </div>
              </div>
            </div>
            
            <div class="image-count" id="image-count">已上传 <span>0</span>/9 张图片</div>
            <!-- 隐藏字段用于存储图片URL -->
            <input type="hidden" name="images" id="images-url" value="">
          </div>
        </div>
      </div>
      
      <div class="layui-form-item">
        <label class="layui-form-label">手机号</label>
        <div class="layui-input-block">
          <input type="text" name="phone" lay-verify="required" autocomplete="off" placeholder="请输入手机号" class="layui-input">
        </div>
      </div>
      
      
    <div class="layui-form-item">
        <label class="layui-form-label">抖音号</label>
        <div class="layui-input-block">
          <input type="text" name="tiktok" lay-verify="required" autocomplete="off" placeholder="请输入抖音号" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">真实姓名</label>
        <div class="layui-input-block">
          <input type="text" name="name" lay-verify="required" autocomplete="off" placeholder="请输入真实姓名" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">性别</label>
        <div class="layui-input-block">
          <input type="radio" name="sex" value="0" title="未知" checked>
          <input type="radio" name="sex" value="1" title="男">
          <input type="radio" name="sex" value="2" title="女">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">年龄</label>
        <div class="layui-input-block">
          <input type="number" name="age" lay-verify="number" autocomplete="off" placeholder="请输入年龄" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">国家</label>
        <div class="layui-input-block">
          <input type="text" name="country" autocomplete="off" placeholder="请输入国家" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">地区</label>
        <div class="layui-input-block">
          <input type="text" name="region" autocomplete="off" placeholder="请输入地区" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">职业</label>
        <div class="layui-input-block">
          <input type="text" name="profession" autocomplete="off" placeholder="请输入职业" class="layui-input">
        </div>
      </div>

      
      

      <div class="layui-form-item">
        <label class="layui-form-label">聊天软件</label>
        <div class="layui-input-block">
          <select name="chat_soft" lay-filter="chat_soft">
            <option value="0">kakao</option>
            <option value="1">LINE</option>
          </select>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">婚姻状况</label>
        <div class="layui-input-block">
          <input type="text" name="marita_status" autocomplete="off" placeholder="请输入婚姻状况" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">来源</label>
        <div class="layui-input-inline">
          <input type="text" name="origin" autocomplete="off" placeholder="请输入来源" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">标签</label>
        <div class="layui-input-inline">
          <select name="tag">
            <option value="0">普通客户</option>
            <option value="1">潜在客户</option>
            <option value="2">重要客户</option>
          </select>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
          <input type="text" name="push_url" autocomplete="off" placeholder="请输入ID" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">状态</label>
        <div class="layui-input-inline">
          <select name="status" lay-filter="type">
            <option value="0">未使用</option>
            <option value="1">已使用</option>
            <option value="2">无效订单</option>
          </select>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">备注</label>
        <div class="layui-input-block">
          <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
        </div>
      </div>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit="" id="tj" style="display:none" lay-filter="form-submit">立即提交</button>
        </div>
      </div>

    </form>

  </div>
</div>
<script src="/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="/lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script>
  // 存储已上传的图片信息
  var uploadedImages = [];
  
  layui.use(['form', 'upload'], function() {
    var form = layui.form,
        upload = layui.upload,
        layer = layui.layer,
        $ = layui.$;
    
    // 初始化图片上传功能
    var uploadInst = upload.render({
      elem: '#upload-btn',
      url: '/admin/upload/image', // 替换为您的上传接口
      accept: 'images',
      acceptMime: 'image/*',
      size: 20 * 1024, // 限制文件大小，单位KB
      multiple: false, // 开启多文件上传
      auto: true, // 选择后自动上传
      choose: function(obj) {
        // 检查是否超过最大数量限制
        var maxCount = 9 - uploadedImages.length;
        if (maxCount <= 0) {
          layer.msg('最多只能上传9张图片', {icon: 2});
          return false; // 阻止选择文件
        }
      },
      before: function() {
        layer.load();
        // 显示上传中的占位符
        var loadingItem = $(
          '<div class="image-item uploading">' +
            '<div style="display:flex;align-items:center;justify-content:center;height:100%;">' +
              '<i class="layui-icon" style="font-size:30px;color:#999;">&#xe63d;</i>' +
            '</div>' +
            '<div class="upload-progress"><div class="progress-bar"></div></div>' +
          '</div>'
        );
        loadingItem.insertBefore('#upload-placeholder');
      },
      progress: function(n, elem, index) {
        // 更新进度条
        var progressBar = $('.image-item.uploading .progress-bar');
        progressBar.css('width', n + '%');
      },
      done: function(res, index) {
        layer.closeAll('loading');
        
        // 移除上传中的占位符
        $('.image-item.uploading').remove();
        
        if (res.code === 0) {
          // 上传成功
          uploadedImages.push(res.url);
          updateImageDisplay();
          layer.msg('图片上传成功', {icon: 1});
        } else {
          layer.msg(res.msg || '上传失败', {icon: 2});
        }
      },
      error: function(index) {
        layer.closeAll('loading');
        // 移除上传中的占位符
        $('.image-item.uploading').remove();
        layer.msg('上传失败，请重试', {icon: 2});
      }
    });
    
    // 更新图片显示
    function updateImageDisplay() {
      // 清空现有的图片显示（除了占位符）
      $('.image-item:not(#upload-placeholder)').remove();
      
      // 显示所有已上传的图片
      $.each(uploadedImages, function(index, url) {
        var imageItem = $(
          '<div class="image-item upload-success" data-url="' + url + '">' +
            '<img src="' + url + '">' +
            '<div class="image-actions">' +
              '<button type="button" class="layui-btn layui-btn-xs layui-btn-primary view-btn">查看</button>' +
              '<button type="button" class="layui-btn layui-btn-xs layui-btn-danger delete-btn">删除</button>' +
            '</div>' +
          '</div>'
        );
        
        // 添加到预览区域（在占位符之前）
        imageItem.insertBefore('#upload-placeholder');
        
        // 绑定查看按钮事件
        imageItem.find('.view-btn').on('click', function() {
          layer.open({
            type: 1,
            title: '预览图片',
            shadeClose: true,
            shade: 0.8,
            area: ['90%', '90%'],
            content: '<div style="text-align:center"><img src="' + url + '" style="max-width:100%;max-height:100%"></div>'
          });
        });
        
        // 绑定删除按钮事件
        imageItem.find('.delete-btn').on('click', function() {
          // 从数组中移除图片
          var arrayIndex = uploadedImages.indexOf(url);
          if (arrayIndex !== -1) {
            uploadedImages.splice(arrayIndex, 1);
            updateImageDisplay();
          }
        });
      });
      
      // 更新计数
      $('#image-count span').text(uploadedImages.length);
      
      // 更新隐藏字段
      $('#images-url').val(JSON.stringify(uploadedImages));
      
      // 控制占位符显示
      if (uploadedImages.length >= 9) {
        $('#upload-placeholder').hide();
        $('#upload-button-container').hide();
      } else {
        $('#upload-placeholder').show();
        $('#upload-button-container').show();
      }
    }
    
    // 点击占位符也触发文件选择
    $('#upload-placeholder').on('click', function() {
      if (uploadedImages.length < 9) {
        $('#upload-btn').click();
      }
    });
    
    // 表单验证
    form.verify({
    //   phone: [/^1[3-9]\d{9}$/, '请输入正确的手机号码'],
      name: function(value) {
        if (value.length < 2) {
          return '姓名至少2个字符';
        }
      }
    });
    
    // 监听提交
    form.on('submit(form-submit)', function(data) {
      console.log('提交数据:', data.field);
      
      // 检查是否已上传图片
      if (uploadedImages.length === 0) {
        layer.msg('请至少上传一张图片', {icon: 2});
        return false;
      }
      data.field.images = JSON.parse(data.field.images).join(',');
      // 显示提交中的加载状态
      var submitIndex = layer.load();
      
      $.ajax({
        type: 'POST',
        dataType: 'json',
        url: '/admin/users/add',
        data: data.field,
        success: function(result) {
          layer.close(submitIndex);
          if (result.code === 1) {
            layer.msg('添加成功', {icon: 1});
            
            // 2秒后关闭当前iframe层并刷新父页面
            setTimeout(function() {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
              parent.location.reload();
            }, 2000);
            
          } else {
            layer.msg(result.msg || '添加失败', {icon: 2});
          }
        },
        error: function() {
          layer.close(submitIndex);
          layer.msg('请求失败，请重试', {icon: 2});
        }
      });
      
      return false; // 阻止表单默认提交
    });
  });
</script>
</body>
</html>